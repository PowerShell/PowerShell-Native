trigger: none

variables:
  - name: ob_outputDirectory
    value: '$(Build.ArtifactStagingDirectory)/ONEBRANCH_ARTIFACT'
  - name: LinuxContainerImage
    value: mcr.microsoft.com/onebranch/azurelinux/build:3.0
  - name: WindowsContainerImage
    value: onebranch.azurecr.io/windows/ltsc2022/vse2022:latest

resources:
  repositories:
  - repository: templates
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main

extends:
  template: v2/OneBranch.NonOfficial.CrossPlat.yml@templates  # The Official template may only be used by Production-classified pipelines

  parameters:
    featureFlags:
      WindowsHostVersion:
        Disk: Large
        Version: 2022
        Network: KS1
      incrementalSDLBinaryAnalysis: true
    cloudvault:
      enabled: false
    globalSdl:
      sbom:
        enabled: true
        packageName: Microsoft.PowerShell.Native
      codeql:
        compiled:
          enabled: true
      armory:
        enabled: false
      credscan:
        enabled: true
        scanFolder:  $(Build.SourcesDirectory)
      binskim:
        enabled: true
      apiscan:
        enabled: false

    stages:
    - stage: WinBuildAndSign
      displayName: Windows Build and Sign
      jobs:
      - template: .pipelines/templates/build-sign-windows.yml@self
        parameters:
          ARCHITECTURE: 'x64'

      - template: .pipelines/templates/build-sign-windows.yml@self
        parameters:
          ARCHITECTURE: 'x86'

      - template: .pipelines/templates/build-sign-windows.yml@self
        parameters:
          ARCHITECTURE: 'x64_arm64'

    - stage: LinuxBuild
      displayName: Linux Build
      jobs:
      - template: .pipelines/templates/build-linux.yml@self
        parameters:
          ARCHITECTURE: 'linux-x64'
          Name: 'Build_Linux_x64'

      - template: .pipelines/templates/build-linux.yml@self
        parameters:
          ARCHITECTURE: 'linux-arm'
          Name: 'Build_Linux_arm'

      - template: .pipelines/templates/build-linux.yml@self
        parameters:
          ARCHITECTURE: 'linux-arm64'
          Name: 'Build_Linux_arm64'

      - template: .pipelines/templates/build-linux.yml@self
        parameters:
          ARCHITECTURE: 'linux-musl-x64'
          Name: 'Build_Linux_musl_x64'
