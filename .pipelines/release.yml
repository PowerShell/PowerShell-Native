trigger: none

variables:
  - name: ob_outputDirectory
    value: '$(Build.ArtifactStagingDirectory)/ONEBRANCH_ARTIFACT'
  - name: LinuxContainerImage
    value: onebranch.azurecr.io/linux/ubuntu-2004:latest
  - name: WindowsContainerImage
    value: onebranch.azurecr.io/windows/ltsc2019/vse2022:latest

resources:
  repositories:
  - repository: templates
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main

extends:
  template: v2/OneBranch.NonOfficial.CrossPlat.yml@templates  # The Official template may only be used by Production-classified pipelines

  parameters:
    featureFlags:
      WindowsHostVersion: 1ESWindows2022
    cloudvault:
      enabled: false
    globalSdl:
      tsa:
        enabled: false # onebranch publish all sdl results to TSA. If TSA is disabled all SDL tools will forced into 'break' build mode.
      credscan:
        enabled: true # enable credscan to run on the pipeline
      binskim:
        break: false # always break the build on binskim issues in addition to TSA upload
      policheck:
        break: true # always break the build on policheck issues. You can disable it by setting to 'false'
      cg:
        enabled: true # enable code governance to run on the pipeline
      armory:
        enabled: false

    stages:
    - stage: Build
      jobs:
      - job: BuildWindowsx64
        pool:
          type: windows

        variables:
          - name: ob_outputDirectory
            value: '$(Build.ArtifactStagingDirectory)/ONEBRANCH_ARTIFACT'

        steps:
        - pwsh: |
            $repoRoot = '$(Build.SourcesDirectory)'
            Import-Module $repoRoot\build.psm1 -Force
            Start-PSBootstrap -BuildWindowsNative
            Write-Verbose "Starting Start-BuildNativeWindowsBinaries" -Verbose
            Start-BuildNativeWindowsBinaries -Configuration 'Release' -Arch x64 -Clean
            Write-Verbose "Completed Start-BuildNativeWindowsBinaries" -Verbose
            $buildOutputPath = Join-Path $repoRoot "src/powershell-win-core"
            Compress-Archive -Path "$buildOutputPath/*.dll" -DestinationPath "$(ob_outputDirectory)/win-x64-symbols.zip" -Verbose
          displayName: 'Build'
